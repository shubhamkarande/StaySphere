---
import Layout from '../../../layouts/Layout.astro';
---

<Layout title="Create Listing - StaySphere">
  <main class="min-h-screen bg-gray-50">
    <div class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Create New Listing</h1>
        <p class="mt-2 text-gray-600">Share your space with travelers from around the world</p>
      </div>

      <form id="listing-form" class="space-y-8">
        <!-- Basic Information -->
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Basic Information</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="md:col-span-2">
              <label for="title" class="block text-sm font-medium text-gray-700 mb-2">Property Title</label>
              <input
                type="text"
                id="title"
                name="title"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Beautiful apartment in downtown"
              />
            </div>
            
            <div class="md:col-span-2">
              <label for="description" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
              <textarea
                id="description"
                name="description"
                rows="4"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Describe your space, amenities, and what makes it special..."
              ></textarea>
            </div>
            
            <div>
              <label for="property_type" class="block text-sm font-medium text-gray-700 mb-2">Property Type</label>
              <select
                id="property_type"
                name="property_type"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Select property type</option>
                <option value="apartment">Apartment</option>
                <option value="house">House</option>
                <option value="villa">Villa</option>
                <option value="cabin">Cabin</option>
                <option value="loft">Loft</option>
                <option value="other">Other</option>
              </select>
            </div>
            
            <div>
              <label for="room_type" class="block text-sm font-medium text-gray-700 mb-2">Room Type</label>
              <select
                id="room_type"
                name="room_type"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Select room type</option>
                <option value="entire_place">Entire place</option>
                <option value="private_room">Private room</option>
                <option value="shared_room">Shared room</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Property Details -->
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Property Details</h2>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            <div>
              <label for="accommodates" class="block text-sm font-medium text-gray-700 mb-2">Guests</label>
              <input
                type="number"
                id="accommodates"
                name="accommodates"
                min="1"
                max="20"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            
            <div>
              <label for="bedrooms" class="block text-sm font-medium text-gray-700 mb-2">Bedrooms</label>
              <input
                type="number"
                id="bedrooms"
                name="bedrooms"
                min="0"
                max="10"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            
            <div>
              <label for="bathrooms" class="block text-sm font-medium text-gray-700 mb-2">Bathrooms</label>
              <input
                type="number"
                id="bathrooms"
                name="bathrooms"
                min="0"
                max="10"
                step="0.5"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>
        </div>

        <!-- Location -->
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Location</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="md:col-span-2">
              <label for="address" class="block text-sm font-medium text-gray-700 mb-2">Street Address</label>
              <input
                type="text"
                id="address"
                name="address"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="123 Main Street"
              />
            </div>
            
            <div>
              <label for="city" class="block text-sm font-medium text-gray-700 mb-2">City</label>
              <input
                type="text"
                id="city"
                name="city"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="New York"
              />
            </div>
            
            <div>
              <label for="state" class="block text-sm font-medium text-gray-700 mb-2">State/Province</label>
              <input
                type="text"
                id="state"
                name="state"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="NY"
              />
            </div>
            
            <div>
              <label for="country" class="block text-sm font-medium text-gray-700 mb-2">Country</label>
              <input
                type="text"
                id="country"
                name="country"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="United States"
              />
            </div>
            
            <div>
              <label for="postal_code" class="block text-sm font-medium text-gray-700 mb-2">Postal Code</label>
              <input
                type="text"
                id="postal_code"
                name="postal_code"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="10001"
              />
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Pricing</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label for="price_per_night" class="block text-sm font-medium text-gray-700 mb-2">Price per Night ($)</label>
              <input
                type="number"
                id="price_per_night"
                name="price_per_night"
                min="1"
                step="0.01"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="100.00"
              />
            </div>
            
            <div>
              <label for="cleaning_fee" class="block text-sm font-medium text-gray-700 mb-2">Cleaning Fee ($)</label>
              <input
                type="number"
                id="cleaning_fee"
                name="cleaning_fee"
                min="0"
                step="0.01"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="25.00"
              />
            </div>
            
            <div>
              <label for="service_fee" class="block text-sm font-medium text-gray-700 mb-2">Service Fee ($)</label>
              <input
                type="number"
                id="service_fee"
                name="service_fee"
                min="0"
                step="0.01"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="15.00"
              />
            </div>
            
            <div>
              <label for="minimum_nights" class="block text-sm font-medium text-gray-700 mb-2">Minimum Nights</label>
              <input
                type="number"
                id="minimum_nights"
                name="minimum_nights"
                min="1"
                max="365"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                value="1"
              />
            </div>
            
            <div>
              <label for="maximum_nights" class="block text-sm font-medium text-gray-700 mb-2">Maximum Nights</label>
              <input
                type="number"
                id="maximum_nights"
                name="maximum_nights"
                min="1"
                max="365"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="30"
              />
            </div>
          </div>
        </div>

        <!-- Images -->
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Photos</h2>
          <p class="text-sm text-gray-600 mb-4">Upload at least 5 high-quality photos of your space</p>
          
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
            <input
              type="file"
              id="images"
              name="images"
              multiple
              accept="image/*"
              class="hidden"
            />
            <label for="images" class="cursor-pointer">
              <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <div class="mt-4">
                <p class="text-sm text-gray-600">
                  <span class="font-medium text-blue-600 hover:text-blue-500">Click to upload</span>
                  or drag and drop
                </p>
                <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB each</p>
              </div>
            </label>
          </div>
          
          <div id="image-preview" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 hidden"></div>
        </div>

        <!-- Amenities -->
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Amenities</h2>
          
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <label class="flex items-center">
              <input type="checkbox" name="amenities" value="wifi" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <span class="ml-2 text-sm text-gray-700">WiFi</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="amenities" value="kitchen" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <span class="ml-2 text-sm text-gray-700">Kitchen</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="amenities" value="parking" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <span class="ml-2 text-sm text-gray-700">Free parking</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="amenities" value="pool" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <span class="ml-2 text-sm text-gray-700">Pool</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="amenities" value="gym" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <span class="ml-2 text-sm text-gray-700">Gym</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="amenities" value="pet_friendly" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <span class="ml-2 text-sm text-gray-700">Pet friendly</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="amenities" value="air_conditioning" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <span class="ml-2 text-sm text-gray-700">Air conditioning</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="amenities" value="heating" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <span class="ml-2 text-sm text-gray-700">Heating</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="amenities" value="washer" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <span class="ml-2 text-sm text-gray-700">Washer</span>
            </label>
            <label class="flex items-center">
              <input type="checkbox" name="amenities" value="tv" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <span class="ml-2 text-sm text-gray-700">TV</span>
            </label>
          </div>
        </div>

        <!-- Policies -->
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Policies</h2>
          
          <div class="space-y-4">
            <div>
              <label for="cancellation_policy" class="block text-sm font-medium text-gray-700 mb-2">Cancellation Policy</label>
              <select
                id="cancellation_policy"
                name="cancellation_policy"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="flexible">Flexible - Full refund 1 day prior to arrival</option>
                <option value="moderate">Moderate - Full refund 5 days prior to arrival</option>
                <option value="strict">Strict - 50% refund up until 1 week prior to arrival</option>
              </select>
            </div>
            
            <div class="flex items-center">
              <input
                type="checkbox"
                id="instant_book"
                name="instant_book"
                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <label for="instant_book" class="ml-2 text-sm text-gray-700">
                Enable instant booking (guests can book immediately without approval)
              </label>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end space-x-4">
          <a href="/dashboard/listings" class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
            Cancel
          </a>
          <button
            type="submit"
            id="submit-button"
            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
          >
            Create Listing
          </button>
        </div>
      </form>
    </div>
  </main>

  <script>
    const API_BASE = 'http://localhost:8000/api';
    let uploadedImages: string[] = [];

    // Handle image upload
    document.getElementById('images')?.addEventListener('change', async function(e) {
      const files = (e.target as HTMLInputElement).files;
      if (!files) return;

      const token = localStorage.getItem('auth_token');
      if (!token) return;

      const preview = document.getElementById('image-preview');
      if (!preview) return;

      preview.innerHTML = '';
      preview.classList.remove('hidden');
      uploadedImages = [];

      for (const file of Array.from(files)) {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('folder', 'listings');

        try {
          const response = await fetch(`${API_BASE}/upload/image`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
          });

          if (response.ok) {
            const result = await response.json();
            uploadedImages.push(result.data.url);
            
            const imageDiv = document.createElement('div');
            imageDiv.className = 'relative';
            imageDiv.innerHTML = `
              <img src="${result.data.url}" alt="Property image" class="w-full h-24 object-cover rounded">
              <button type="button" onclick="removeImage('${result.data.url}')" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                ×
              </button>
            `;
            preview.appendChild(imageDiv);
          }
        } catch (error) {
          console.error('Failed to upload image:', error);
        }
      }
    });

    // Remove image function
    (window as any).removeImage = function(url: string) {
      uploadedImages = uploadedImages.filter(img => img !== url);
      const preview = document.getElementById('image-preview');
      if (preview) {
        const imageElements = preview.querySelectorAll('img');
        imageElements.forEach(img => {
          if (img.src === url) {
            img.parentElement?.remove();
          }
        });
      }
    };

    // Handle form submission
    document.getElementById('listing-form')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const token = localStorage.getItem('auth_token');
      if (!token) {
        window.location.href = '/auth/login';
        return;
      }

      if (uploadedImages.length === 0) {
        alert('Please upload at least one image');
        return;
      }

      const formData = new FormData(this as HTMLFormElement);
      const listingData: any = Object.fromEntries(formData.entries());
      
      // Handle amenities
      const amenities = formData.getAll('amenities');
      listingData.amenities = amenities;
      
      // Add uploaded images
      listingData.images = uploadedImages;
      
      // Convert boolean fields
      listingData.instant_book = formData.has('instant_book');
      
      const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
      
      try {
        submitButton.disabled = true;
        submitButton.textContent = 'Creating...';
        
        const response = await fetch(`${API_BASE}/listings`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(listingData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Listing created successfully!');
          window.location.href = '/dashboard/listings';
        } else {
          throw new Error(result.message || 'Failed to create listing');
        }
      } catch (error) {
        console.error('Failed to create listing:', error);
        alert('Failed to create listing. Please try again.');
        submitButton.disabled = false;
        submitButton.textContent = 'Create Listing';
      }
    });
  </script>
</Layout>